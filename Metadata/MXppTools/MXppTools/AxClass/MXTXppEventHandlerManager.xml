<?xml version="1.0" encoding="utf-8"?>
<AxClass xmlns:i="http://www.w3.org/2001/XMLSchema-instance">
	<Name>MXTXppEventHandlerManager</Name>
	<SourceCode>
		<Declaration><![CDATA[
using XppInterpreter.Interpreter.Proxy;

public class MXTXppEventHandlerManager
{
    public readonly MXTXppEventHandlerTable handlerTable;
    private boolean isValid;
    private XppInterpreter.Core.Events.EventHandler handler;

    private XppProxy proxy = new XppProxy(
            new MXTXppIntrinsicFunctionProvider(),
            new MXTXppBinaryOperationProxy(),
            new MXTXppCastingProxy(),
            new MXTXppUnaryOperationProxy(),
            new MXTXppDataAccessProxy(),
            new MXTXppReflectionProxy(),
            new MXTXppExceptionsProxy(),
            new MXTXppQueryGenerationProxy());

}
]]></Declaration>
		<Methods>
			<Method>
				<Name>new</Name>
				<Source><![CDATA[
	void new(MXTXppEventHandlerTable _table)
    {
        this.handlerTable = _table;

        if (!_table)
        {
            throw error(error::missingParameter(this));
        }

        handler = new XppInterpreter.Core.Events.EventHandler(
            _table.getDelegateType(),
            _table.getElementType(),
            _table.MethodName, 
            _table.HandlerSourceCode, 
            proxy);
	}

]]></Source>
			</Method>
			<Method>
				<Name>validate</Name>
				<Source><![CDATA[
    public void validate()
    {
        handler.Compile();
    }

]]></Source>
			</Method>
			<Method>
				<Name>getDataEventTypeFromName</Name>
				<Source><![CDATA[
    public static Dynamics.AX.Application.DataEventType getDataEventTypeFromName(str _name)
    {
        if (strStartsWith(_name, "On"))
        {
            _name = strReplace(_name, "On", "");
        }

        MXTXppReflectionProxy pr = new MXTXppReflectionProxy();
        return pr.GetEnumValue("DataEventType", _name);
    }

]]></Source>
			</Method>
			<Method>
				<Name>subscribeToDataEvent</Name>
				<Source><![CDATA[
    private void subscribeToDataEvent()
    {
        handler.InitializeDelegate();

        this.unsubscribeToDataEvent();

        XppInterpreter.Core.Events.EventHandlerStore::Set(handler.Key, handler);

        Microsoft.Dynamics.Ax.Xpp.DataEventManager::Subscribe(
            handlerTable.ElementName, 
            MXTXppEventHandlerManager::getDataEventTypeFromName(handlerTable.MethodName),
            handler.Delegate);
    }

]]></Source>
			</Method>
			<Method>
				<Name>unsubscribeToDataEvent</Name>
				<Source><![CDATA[
    private void unsubscribeToDataEvent()
    {
        XppInterpreter.Core.Events.EventHandler subscribedHandler = XppInterpreter.Core.Events.EventHandlerStore::Remove(handler.Key);
        
        if (subscribedHandler != null && subscribedHandler.Delegate != null)
        {
            Microsoft.Dynamics.Ax.Xpp.DataEventManager::Unsubscribe(
                handlerTable.ElementName,
                MXTXppEventHandlerManager::getDataEventTypeFromName(handlerTable.MethodName),
                subscribedHandler.Delegate);
        }
    }

]]></Source>
			</Method>
			<Method>
				<Name>subscribeToEvent</Name>
				<Source><![CDATA[
    private void subscribeToEvent()
    {
        if (handlerTable.HandlerType == MXTXppEventHandlerType::DataEvent)
        {
            this.subscribeToDataEvent();
        }
        else
        {
            XppInterpreter.Core.Events.MethodEventHandlerHelper::Subscribe(handler);
        }
    }

]]></Source>
			</Method>
			<Method>
				<Name>unsubscribeToEvent</Name>
				<Source><![CDATA[
    private void unsubscribeToEvent()
    {
        if (handlerTable.HandlerType == MXTXppEventHandlerType::DataEvent)
        {
            this.unsubscribeToDataEvent();
        }
        else
        {
            XppInterpreter.Core.Events.MethodEventHandlerHelper::Unsubscribe(handler);
        }
    }

]]></Source>
			</Method>
			<Method>
				<Name>activate</Name>
				<Source><![CDATA[
    public void activate()
    {
        System.Exception ex;

        try
        {
            this.subscribeToEvent();
        }
        catch (ex)
        {
            error("An error occured while activating the handler.");
            throw ex;
        }
    }

]]></Source>
			</Method>
			<Method>
				<Name>deactivate</Name>
				<Source><![CDATA[
    public void deactivate()
    {
        System.Exception ex;

        try
        {
            this.unsubscribeToEvent();
        }
        catch (ex)
        {
            error("An error occured while deactivating the handler.");
            throw ex;
        }
    }

]]></Source>
			</Method>
			<Method>
				<Name>confirm</Name>
				<Source><![CDATA[
    private static boolean confirm(MXTXppEventHandlerTable _handler, boolean _isActivation)
    {
        str msg = strFmt("You are about to %1 the event handler for %2 %3 %4. Do you want to continue?",
            _isActivation ? "activate" : "deactivate",
            _handler.ElementType,
            _handler.ElementName,
            _handler.DisplayMethodName);

        str title = strFmt("%1 event handler", _isActivation ? "Activate" : "Deactivate");

        return Box::yesNo(msg, DialogButton::No, title) == DialogButton::Yes;
    }

]]></Source>
			</Method>
			<Method>
				<Name>main</Name>
				<Source><![CDATA[
    public static void main(Args _args)
    {
        if (_args.dataset() != tableNum(MXTXppEventHandlerTable))
        {
            throw error(error::missingRecord(tableStr(MXTXppEventHandlerTable)));
        }

        if (_args.parmEnumType() != enumNum(NoYes))
        {
            throw error(error::missingParameter(_args));
        }

        MXTXppEventHandlerTable record = _args.record();

        record.reread();
        record.selectForUpdate(true);

        if (_args.parmEnum() == NoYes::Yes &&
            MXTXppEventHandlerTable::activeExists(record))
        {
            warning("Another Active event handler for the same event exist. Only one event handler can be active for the same Event");
            return;
        }

        MXTXppEventHandlerManager handler = new MXTXppEventHandlerManager(record);
        
        if (_args.parmEnum() == NoYes::No)
        {
            if (record.Active && MXTXppEventHandlerManager::confirm(record, false))
            {
                handler.deactivate();

                ttsbegin;
                record.setInactive();
                record.update();
                ttscommit;
            }
        }
        else if (!record.Active)
        {
            handler.validate();

            if (MXTXppEventHandlerManager::confirm(record, true))
            {
                handler.activate();
                
                ttsbegin;
                record.setActive();
                record.update();
                ttscommit;
            }
        }

        FormRun formRun = _args.caller();

        if (formRun)
        {
            FormDataSource dataSource = formRun.dataSource(tableStr(MXTXppEventHandlerTable));
            if (dataSource)
            {
                dataSource.refresh();
                dataSource.research(true);
            }
        }
    }

]]></Source>
			</Method>
		</Methods>
	</SourceCode>
</AxClass>